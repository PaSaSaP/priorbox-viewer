!function(a){"use strict";function b(b,c,d){function e(a){if(a.length<1)return new o;for(var b=new n(a[0].x,a[0].y),c=b,d=null,e=1;e<a.length;e++){if(d=new n(a[e].x,a[e].y),d.equals(b)){c.next=b;break}c.next=d,c=d}return new o(b)}function f(a){if("undefined"==typeof a||null===a)return[];var b=[],c=a.getVertices();c[c.length-1].next===c[0]&&c.push(c[0]);for(var d=0;d<c.length;d++)b.push({x:c[d].position.x,y:c[d].position.y});return b}function g(){K=G.height/F.image.height*F.image.width<=G.width?G.height/F.image.height:G.width/F.image.width,M.x=F.image.width/2,M.y=F.image.height/2,I=!0,h()}function h(){if(I){I=!1;var b=H;b.clearRect(0,0,G.width,G.height),b.save();var c=G.width/2-M.x*K,d=G.height/2-M.y*K;if(b.translate(c,d),b.scale(K,K),b.drawImage(F.image,0,0),b.restore(),ib&&null!==F.solution&&(F.solution.draw(b),hb&&!F.solution.isClosed())){var e=F.solution.getLastVertex().position,f=l(eb),g={x:f.x-e.x,y:f.y-e.y};i(b,e,g,"#FF3300",N)}kb&&F.annotations.forEach(function(a){a.polygon.draw(b,a.color)}),ib&&null!==F.solution&&F.solution.draw(b),gb&&null!==F.answer&&r(b),j(b)}J||a.requestAnimationFrame(h)}function i(a,b,c,d,e){a.save(),a.strokeStyle=d,a.lineWidth=e;var f=m(b),g={x:0,y:0};a.translate(f.x,f.y),a.scale(K,K),a.beginPath(),a.moveTo(g.x,g.y),a.lineTo(c.x,c.y),a.stroke(),a.restore()}function j(a){for(var b=10,c=20,d=2*c+b,e=G.width-c-b,f=G.height-c-b,g=0;g<ab.length;g++)ab[g].draw(a,e,f-d*g,c);if(null!==bb){a.save(),a.globalAlpha=.5;var h=c;a.font=h+"px sans-serif";var i=a.measureText(bb).width,j=i+b,l=.7*h+b,m=G.width-(2*c+2*b)-j,n=G.height-l-b,o=m+.5*b,p=G.height-1.5*b;a.fillStyle="#000000",k(a,m,n,j,l,8,!0,!1),a.fillStyle="#ffffff",a.fillText(bb,o,p),a.restore()}}function k(a,b,c,d,e,f,g,h){f="number"==typeof f?f:5,g="boolean"==typeof g?g:!0,h="boolean"==typeof h?h:!1,a.beginPath(),a.moveTo(b+f,c),a.lineTo(b+d-f,c),a.quadraticCurveTo(b+d,c,b+d,c+f),a.lineTo(b+d,c+e-f),a.quadraticCurveTo(b+d,c+e,b+d-f,c+e),a.lineTo(b+f,c+e),a.quadraticCurveTo(b,c+e,b,c+e-f),a.lineTo(b,c+f),a.quadraticCurveTo(b,c,b+f,c),a.closePath(),g&&a.fill(),h&&a.stroke()}function l(a){var b={x:M.x>=G.width/K/2?M.x-G.width/K/2:0,y:M.y>=G.height/K/2?M.y-G.height/K/2:0},c={x:M.x>=G.width/K/2?0:G.width/2-M.x*K,y:M.y>=G.height/K/2?0:G.height/2-M.y*K},d={};return d.x=b.x+a.x/K-c.x/K,d.y=b.y+a.y/K-c.y/K,d}function m(a){return{x:(a.x+G.width/K/2-M.x)*K,y:(a.y+G.height/K/2-M.y)*K}}function n(a,b){var c=this,d=this.position={x:a,y:b};this.next=null,this.handleWidth=12,this.onClick=function(){return P===O.SOLUTION_POINT_DELETE?(F.solution.deleteVertex(c),F.onSolutionChange(F.exportSolution()),void(I=!0)):P===O.SOLUTION_DRAW&&null!==F.solution&&c.equals(F.solution.initialVertex)?(F.solution.close(),P=O.DEFAULT,void F.onSolutionChange(F.exportSolution())):void 0},this.onMouseDown=function(){return P===O.SOLUTION_MOVE?(cb=d,db=!0,!0):!1}}function o(a){this.initialVertex=a||null}function p(a,b,c){return(b.x-a.x)*(c.y-a.y)-(c.x-a.x)*(b.y-a.y)}function q(){var a="#0000ff";return ib&&(a=null!==F.solution&&F.solution.isWithinBounds(F.answer.x,F.answer.y)?"#00ff00":"#ff0000"),a}function r(a){a.save();var b=1.5,c=m(F.answer);a.translate(c.x,c.y),a.scale(b*K,b*K),a.shadowColor="#ffffff",a.shadowBlur=5,A(a,"",q(),0,0,50),a.restore()}function s(){var a=null!==F.solution&&hb?F.solution.getVertices():[];return ab.concat(a)}function t(a){var b=G.getBoundingClientRect(),c={x:a.clientX-b.left,y:a.clientY-b.top},d=s().filter(function(a){return a.isWithinBounds(c.x,c.y)});return d.length>0?d[0]:null}function u(a){if(0===a.button){var b=t(a);null!==b&&b.onMouseDown(a)||(db=!0)}}function v(a){0===a.button&&(cb=M,db=!1)}function w(a){if(0===a.button){var b=t(a);if(null!==b)b.onClick(a);else{var c=G.getBoundingClientRect(),d={x:a.clientX-c.left,y:a.clientY-c.top};if(P===O.ANSWER_DRAW&&(F.answer=l(d),I=!0),P===O.SOLUTION_DRAW){if(a.shiftKey)null!==F.solution&&(F.solution.close(),P=O.DEFAULT,F.onSolutionChange(F.exportSolution()));else{var e=l(d),f=new n(e.x,e.y);null===F.solution&&(F.solution=new o),F.solution.addVertex(f)}F.onSolutionChange(F.exportSolution()),I=!0}}}}function x(a){a||(a=event),a.preventDefault(),a.detail<0||a.wheelDelta>0?F.zoomOut():F.zoomIn()}function y(a){var b=G.getBoundingClientRect(),c={x:a.clientX-b.left,y:a.clientY-b.top};eb=eb||{x:0,y:0};var d=c.x-eb.x,e=c.y-eb.y;if(db)cb===M?(cb.x-=d/K,cb.y-=e/K):(cb.x+=d/K,cb.y+=e/K),F.onSolutionChange(F.exportSolution()),I=!0;else{var f=t(a),g=bb;bb=null!==f&&"undefined"!=typeof f.tooltip?f.tooltip:null,g!==bb&&(I=!0)}eb=c,hb&&Math.max(Math.abs(d),Math.abs(e))>2&&(I=!0)}function z(a,b){this.drawPosition=null,this.drawRadius=0,this.alpha=.5,this.color="#000000",this.icon=a,this.iconColor="#ffffff",this.tooltip=b||null,this.enabled=!1,this.enabledAlpha=.7,this.onClick=function(){alert("no click action set!")},this.onMouseDown=function(){return!1}}function A(a,b,c,d,e,f){a.font=f+"px FontAwesome",a.fillStyle=c;var g=a.measureText(b),h=d-g.width/2,i=e+.7*f/2;a.fillText(b,h,i)}function B(a,b,c){a.addEventListener(b,c),Q.push({eventTarget:a,eventType:b,listener:c})}function C(){var a,b,c=Q.slice();for(a=0;a<c.length;a++)b=c[a],b.eventTarget.removeEventListener(b.eventType,b.listener);Q=[]}function D(){B(document,"mousedown",u),B(document,"mouseup",v),B(G,"DOMMouseScroll",x),B(G,"mousewheel",x),B(G,"mousemove",y),B(G,"click",w)}function E(){F.image.addEventListener("load",g,!1),F.image.src=c,"[object Array]"===Object.prototype.toString.call(d.solution)&&F.importSolution(d.solution),R.onClick=function(){F.zoomOut()},S.onClick=function(){F.zoomIn()},fb&&(U.onClick=function(){F.answer=null,I=!0},V.enabled=function(){return P===O.ANSWER_DRAW},V.onClick=function(){P=P===O.ANSWER_DRAW?O.DEFAULT:O.ANSWER_DRAW,I=!0},ab=T.concat(W)),hb&&(X.enabled=function(){return P===O.SOLUTION_DRAW},X.onClick=function(){P=P===O.SOLUTION_DRAW?O.DEFAULT:O.SOLUTION_DRAW,I=!0},Y.enabled=function(){return P===O.SOLUTION_MOVE},Y.onClick=function(){P=P===O.SOLUTION_MOVE?O.DEFAULT:O.SOLUTION_MOVE,I=!0},Z.enabled=function(){return P===O.SOLUTION_POINT_DELETE},Z.onClick=function(){P=P===O.SOLUTION_POINT_DELETE?O.DEFAULT:O.SOLUTION_POINT_DELETE,I=!0},$.onClick=function(){F.solution=null,F.onSolutionChange(F.exportSolution()),I=!0},ab=T.concat(_)),D()}var F=this;d="object"==typeof d?d:{};var G=document.getElementById(b),H=G.getContext("2d"),I=!0,J=!1,K=1,L=.1,M={x:0,y:0},N=3,O={DEFAULT:0,ANSWER_DRAW:1,SOLUTION_DRAW:2,SOLUTION_MOVE:3,SOLUTION_POINT_DELETE:4,ANNOTATION_SELECT:5,ANNOTATION_DRAW:6,ANNOTATION_MOVE:7,ANNOTATION_DISPLAY:8},P=O.DEFAULT,Q=[],R=new z("","Zoom out"),S=new z("","Zoom in"),T=[R,S],U=new z("","Delete answer"),V=new z("","Set answer"),W=[U,V],X=new z("","Draw new solution point (close with shift-click)"),Y=new z("","Move solution point"),Z=new z("","Delete solution point"),$=new z("","Delete solution"),_=[$,Z,Y,X],ab=T.slice(),bb=null,cb=M,db=!1,eb=null,fb="string"==typeof d.mode&&"editAnswer"===d.mode,gb=fb||"string"==typeof d.mode&&"showSolution"===d.mode,hb="string"==typeof d.mode&&"editSolution"===d.mode,ib=hb||"string"==typeof d.mode&&"showSolution"===d.mode,jb="string"==typeof d.mode&&"editAnnotations"===d.mode,kb=jb||"string"==typeof d.mode&&"showAnnotations"===d.mode;this.image=new Image,this.answer="object"==typeof d.answer&&null!==d.answer?d.answer:null,this.solution=null,this.annotations=[],this.exportSolution=function(){return f(this.solution)},this.importSolution=function(a){this.solution=a.length>=1?e(a):null,I=!0},this.exportAnnotations=function(){return this.annotations.map(function(a){return{color:a.color,polygon:f(a.polygon)}})},this.importAnnotations=function(a){this.annotations=a.map(function(a){return{color:a.color,polygon:e(a.polygon)}})},this.onSolutionChange=function(){},this.onAnnotationChange=function(){},this.zoomIn=function(){K*=1+L,I=!0},this.zoomOut=function(){K*=1-L,I=!0},n.prototype.equals=function(a){return this.position.x===a.position.x&&this.position.y===a.position.y},n.prototype.isWithinBounds=function(a,b){var c=m(this.position);return a>=c.x-this.handleWidth/2&&a<=c.x+this.handleWidth/2&&b>=c.y-this.handleWidth/2&&b<=c.y+this.handleWidth/2},n.prototype.drawHandle=function(a){a.save();var b=m(this.position);a.translate(b.x,b.y),a.fillStyle="#FFFFFF",a.strokeStyle="#000000",a.beginPath(),a.rect(-this.handleWidth/2,-this.handleWidth/2,this.handleWidth,this.handleWidth),a.stroke(),a.fill(),a.restore()},o.prototype.addVertex=function(a){if(null!==this.initialVertex){for(var b=this.initialVertex;null!==b.next&&b.next!==this.initialVertex;)b=b.next;b.next=a}else this.initialVertex=a;I=!0},o.prototype.deleteVertex=function(a){if(null!==this.initialVertex&&this.initialVertex.equals(a))this.initialVertex=this.initialVertex.next;else for(var b=!1,c=this.initialVertex,d=c.next;!b&&null!==d&&d!==this.initialVertex;)d.equals(a)?(c.next=d.next,b=!0):(c=d,d=c.next)},o.prototype.getVertices=function(){for(var a=[],b=this.initialVertex;null!==b;)-1===a.indexOf(b)&&a.push(b),b=b.next!==this.initialVertex?b.next:null;return a},o.prototype.draw=function(a,b,c){if(null!==this.initialVertex&&null!==this.initialVertex.next){var d,e={x:0,y:0},f=this.initialVertex,g=m(this.initialVertex.position);a.save(),a.globalAlpha=.7,a.translate(g.x,g.y),a.scale(K,K),a.beginPath(),a.moveTo(e.x,e.y);do d=f.next,e={x:e.x+(d.position.x-f.position.x),y:e.y+(d.position.y-f.position.y)},a.lineTo(e.x,e.y),f=d;while(null!==f.next&&f!==this.initialVertex);a.fillStyle=b||"#0000FF",a.strokeStyle=c||"#66FF33",f===this.initialVertex&&(a.strokeStyle=c||"#000000",a.closePath(),a.fill()),a.lineWidth=N,a.stroke(),a.restore()}hb&&this.getVertices().forEach(function(b){b.drawHandle(a)})},o.prototype.isClosed=function(){for(var a=this.initialVertex;null!==a.next&&a.next!==this.initialVertex;)a=a.next;return a.next===this.initialVertex},o.prototype.getLastVertex=function(){for(var a=this.initialVertex;null!==a.next&&a.next!==this.initialVertex;)a=a.next;return a},o.prototype.isWithinBounds=function(a,b){var c=this.getVertices(),d=0,e={x:a,y:b};if(c[c.length-1].next!==c[0])return!1;for(var f=0;f+1<c.length;f++)c[f].position.y<=e.y?c[f+1].position.y>e.y&&p(c[f].position,c[f+1].position,e)>0&&d++:c[f+1].position.y<=e.y&&p(c[f].position,c[f+1].position,e)<0&&d--;return 0!==d},o.prototype.close=function(){this.getVertices().length>2&&this.addVertex(this.initialVertex)},z.prototype.isWithinBounds=function(a,b){if(null===this.drawPosition)return!1;var c=Math.abs(this.drawPosition.x-a),d=Math.abs(this.drawPosition.y-b);return c*c+d*d<=this.drawRadius*this.drawRadius},z.prototype.draw=function(a,b,c,d){this.drawPosition={x:b,y:c},this.drawRadius=d,a.save();var e="function"==typeof this.enabled?this.enabled():this.enabled;a.globalAlpha=e?this.enabledAlpha:this.alpha,a.fillStyle=this.color,a.lineWidth=0,a.beginPath(),a.arc(b,c,d,0,2*Math.PI),a.closePath(),a.fill(),a.save(),a.globalCompositeOperation="destination-out",A(a,this.icon,this.iconColor,b,c,d),a.restore(),a.restore()},this.dispose=function(){C(),J=!0},this.refresh=function(){F.dirty=!0},E()}a.ImageViewer=b}(window);